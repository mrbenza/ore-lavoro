/* Material Design Buttons - Mobile First */
        .btn {
            border: none;
            border-radius: var(--radius-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            font-size: 0.9rem; /* Leggermente pi√π piccolo */
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            min-height: var(--touch-target-large); /* Target touch pi√π grande */
            width: 100%; /* Full width su mobile */
            box-sizing: border-box;
            /* Ottimizzazioni touch */
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--on-primary);
            box-shadow: var(--shadow-2);
        }

        .btn-primary:hover:not(:disabled),
        .btn-primary:active:not(:disabled) { /* Aggiunto :active per mobile */
            background: var(--primary-variant);
            box-shadow: var(--shadow-3);
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            background: var(--text-disabled);
            color: rgba(255, 255, 255, 0.6);
            cursor: not-allowed;
            transform: none;
            box-shadow: var(--shadow-1);
        }

        .save-section {
            text-align: center;
            margin-top: var(--spacing-lg);
            padding: var(--spacing-md) 0;
        }

        .save-info {
            margin-top: var(--spacing-md);
            font-size: 0.8rem; /* Ridotto per mobile */
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            line-height: 1.3;
        }

        /* Material Design Notifications - Mobile */
        .notification {
            position: fixed;
            top: var(--spacing-sm);
            right: var(--spacing-sm);
            left: var(--spacing-sm);
            padding: var(--spacing-md);
            border-radius: var(--radius-sm);
            color: white;
            font-weight: 400;
            z-index: 1000;
            transform: translateY(-100px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: var(--shadow-3);
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-sm);
            font-size: 0.9rem;
            line-height: 1.4;
            /* Mobile safe area */
            padding-top: calc(var(--spacing-md) + env(safe-area-inset-top, 0px));
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification.success {
            background: var(--success);
        }

        .notification.error {
            background: var(--error);
        }

        .notification.warning {
            background: var(--warning);
            color: var(--on-surface);
        }

        .notification.security {
            background: var(--primary);
        }

        /* Loading Animation - Mobile */
        .loading {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: currentColor;
            animation: spin 1s ease-in-out infinite;
            flex-shrink: 0;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Version Badge - Mobile */
        .version-badge {
            position: fixed;
            bottom: calc(var(--spacing-sm) + env(safe-area-inset-bottom, 0px));
            right: var(--spacing-sm);
            background: var(--primary);
            color: var(--on-primary);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-xl);
            font-size: 0.7rem; /* Pi√π piccolo su mobile */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: var(--shadow-2);
            z-index: 100;
            min-height: var(--touch-target);
            display: flex;
            align-items: center;
            -webkit-tap-highlight-color: transparent;
        }

        .version-badge:hover,
        .version-badge:active {
            transform: translateY(-2px);
            box-shadow: var(--shadow-3);
        }

        /* Material Icons - Mobile */
        .material-icon {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 20px; /* Leggermente pi√π piccolo su mobile */
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-smoothing: antialiased;
            flex-shrink: 0;
        }

        /* Responsive Design - Tablet & Desktop */
        @media (min-width: 480px) {
            .container {
                padding: var(--spacing-md);
            }
            
            .stats-container {
                gap: var(--spacing-md);
            }
            
            .stat-number {
                font-size: 1.8rem;
            }
            
            .hours-input {
                font-size: 1.8rem !important;
            }
        }

        @media (min-width: 768px) {
            .container {
                max-width: 900px;
                margin: 0 auto;
                padding: var(--spacing-lg);
            }

            .header-content {
                padding: var(--spacing-xl);
            }

            .greeting-text h1 {
                font-size: 1.8rem;
            }

            .main-content {
                padding: var(--spacing-xl);
            }

            .form-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--spacing-xl);
            }

            .btn {
                width: auto;
                min-width: 200px;
            }

            .notification {
                right: var(--spacing-lg);
                left: auto;
                max-width: 400px;
                padding-top: var(--spacing-md);
            }

            .stat-number {
                font-size: 2.2rem;
            }

            .hours-input {
                font-size: 2.2rem !important;
            }
        }

        @media (min-width: 1024px) {
            .form-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .hours-group {
                grid-column: span 3;
                max-width: 400px;
                margin: 0 auto;
            }

            .stat-number {
                font-size: 2.5rem;
            }

            .hours-input {
                font-size: 2.5rem !important;
            }
        }

        /* Mobile Safari specific fixes */
        @supports (-webkit-touch-callout: none) {
            .input-field {
                /* Fix per zoom automatico su iOS */
                transform: translateZ(0);
            }
            
            .btn {
                /* Fix per double-tap su iOS */
                -webkit-tap-highlight-color: rgba(0,0,0,0);
            }
        }

        /* Dark mode support - Mobile friendly */
        @media (prefers-color-scheme: dark) {
            :root {
                --background: #121212;
                --surface: #1e1e1e;<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gestione Ore Lavoro V3.5</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Material Design Colors */
            --primary: #1976d2;
            --primary-variant: #1565c0;
            --secondary: #03dac6;
            --background: #f5f5f5;
            --surface: #ffffff;
            --error: #b00020;
            --success: #4caf50;
            --warning: #ff9800;
            --on-primary: #ffffff;
            --on-secondary: #000000;
            --on-background: #000000;
            --on-surface: #000000;
            --text-primary: rgba(0, 0, 0, 0.87);
            --text-secondary: rgba(0, 0, 0, 0.6);
            --text-disabled: rgba(0, 0, 0, 0.38);
            
            /* Shadows */
            --shadow-1: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --shadow-2: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            --shadow-3: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
            --shadow-4: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
            
            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            
            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            margin: 0;
            padding: var(--spacing-md);
        }

        /* Header Material Design */
        .header {
            background: var(--primary);
            color: var(--on-primary);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-md);
            box-shadow: var(--shadow-2);
            overflow: hidden;
        }

        .header-content {
            padding: var(--spacing-lg) var(--spacing-md);
        }

        .user-greeting {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .greeting-text h1 {
            font-size: 1.5rem;
            font-weight: 400;
            margin-bottom: var(--spacing-xs);
            line-height: 1.2;
        }

        .greeting-text .subtitle {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--on-primary);
            border-radius: var(--radius-xl);
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 300;
            display: block;
            margin-bottom: var(--spacing-xs);
        }

        .stat-label {
            font-size: 0.75rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--spacing-xs);
        }

        .auto-badge {
            display: inline-block;
            background: var(--secondary);
            color: var(--on-secondary);
            font-size: 0.625rem;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Main Content Material Design */
        .main-content {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-1);
            margin-bottom: var(--spacing-md);
        }

        .form-title {
            font-size: 1.25rem;
            font-weight: 400;
            color: var(--text-primary);
            margin-bottom: var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .form-grid {
            display: grid;
            gap: var(--spacing-lg);
            grid-template-columns: 1fr;
        }

        /* Material Design Input Fields */
        .input-group {
            position: relative;
        }

        .input-field {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-md) var(--spacing-sm);
            border: 1px solid rgba(0, 0, 0, 0.12);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            background: transparent;
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
        }

        .input-field:focus + .input-label,
        .input-field:not(:placeholder-shown) + .input-label {
            transform: translateY(-1.25rem) scale(0.75);
            color: var(--primary);
        }

        .input-label {
            position: absolute;
            left: var(--spacing-md);
            top: var(--spacing-md);
            color: var(--text-secondary);
            pointer-events: none;
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
            transform-origin: left top;
            background: var(--surface);
            padding: 0 var(--spacing-xs);
        }

        .input-helper {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: var(--spacing-xs);
            padding-left: var(--spacing-md);
        }

        .input-error {
            border-color: var(--error) !important;
            box-shadow: 0 0 0 2px rgba(176, 0, 32, 0.1) !important;
        }

        .error-message {
            color: var(--error);
            font-size: 0.75rem;
            margin-top: var(--spacing-xs);
            padding-left: var(--spacing-md);
            display: none;
        }

        /* Hours Input Special Styling */
        .hours-group {
            grid-column: 1 / -1;
        }

        .hours-input {
            text-align: center;
            font-size: 2rem !important;
            font-weight: 300;
            padding-top: var(--spacing-lg) !important;
            background: rgba(25, 118, 210, 0.05);
        }

        .hours-label {
            font-size: 1rem !important;
            font-weight: 500;
        }

        /* Material Design Buttons */
        .btn {
            border: none;
            border-radius: var(--radius-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            min-height: 48px;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--on-primary);
            box-shadow: var(--shadow-2);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-variant);
            box-shadow: var(--shadow-3);
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            background: var(--text-disabled);
            color: rgba(255, 255, 255, 0.6);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .save-section {
            text-align: center;
            margin-top: var(--spacing-xl);
        }

        .save-info {
            margin-top: var(--spacing-md);
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
        }

        /* Material Design Notifications */
        .notification {
            position: fixed;
            top: var(--spacing-md);
            right: var(--spacing-md);
            left: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--radius-sm);
            color: white;
            font-weight: 400;
            z-index: 1000;
            transform: translateY(-100px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: var(--shadow-3);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification.success {
            background: var(--success);
        }

        .notification.error {
            background: var(--error);
        }

        .notification.warning {
            background: var(--warning);
            color: var(--on-surface);
        }

        .notification.security {
            background: var(--primary);
        }

        /* Loading Animation */
        .loading {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: currentColor;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Version Badge */
        .version-badge {
            position: fixed;
            bottom: var(--spacing-md);
            right: var(--spacing-md);
            background: var(--primary);
            color: var(--on-primary);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-xl);
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: var(--shadow-2);
        }

        .version-badge:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-3);
        }

        /* Material Icons */
        .material-icon {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-smoothing: antialiased;
        }

        /* Responsive Design - Desktop */
        @media (min-width: 768px) {
            .container {
                max-width: 900px;
                margin: 0 auto;
                padding: var(--spacing-lg);
            }

            .header-content {
                padding: var(--spacing-xl);
            }

            .greeting-text h1 {
                font-size: 2rem;
            }

            .stats-container {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--spacing-lg);
            }

            .stat-card {
                padding: var(--spacing-lg);
            }

            .stat-number {
                font-size: 2.5rem;
            }

            .form-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--spacing-xl);
            }

            .main-content {
                padding: var(--spacing-xl);
            }

            .notification {
                right: var(--spacing-lg);
                left: auto;
                max-width: 400px;
            }
        }

        @media (min-width: 1024px) {
            .form-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .hours-group {
                grid-column: span 3;
                max-width: 400px;
                margin: 0 auto;
            }
        }

        /* Dark mode support (optional) */
        @media (prefers-color-scheme: dark) {
            :root {
                --background: #121212;
                --surface: #1e1e1e;
                --on-background: #ffffff;
                --on-surface: #ffffff;
                --text-primary: rgba(255, 255, 255, 0.87);
                --text-secondary: rgba(255, 255, 255, 0.6);
                --text-disabled: rgba(255, 255, 255, 0.38);
            }
        }
    </style>
    <!-- Google Fonts and Material Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header Material Design -->
        <div class="header">
            <div class="header-content">
                <div class="user-greeting">
                    <div class="greeting-text">
                        <h1 id="userName">Caricamento...</h1>
                        <div class="subtitle">Dashboard Gestione Ore</div>
                    </div>
                    
                    <button class="logout-btn" onclick="logout()">
                        <span class="material-icon">logout</span>
                        Esci
                    </button>
                </div>
                
                <div class="stats-container">
                    <div class="stat-card">
                        <span class="stat-number" id="monthlyHours">0</span>
                        <div class="stat-label">Ore Mese Corrente</div>
                        <span class="auto-badge">Auto</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="previousMonthHours">0</span>
                        <div class="stat-label">Ore Mese Precedente</div>
                        <span class="auto-badge">Auto</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Material Design -->
        <div class="main-content">
            <div class="form-title">
                <span class="material-icon">work</span>
                Registra Ore Lavorate
            </div>
            
            <form id="workEntryForm">
                <div class="form-grid">
                    <!-- Data -->
                    <div class="input-group">
                        <input type="date" id="workDate" name="workDate" class="input-field" placeholder=" " required>
                        <label for="workDate" class="input-label">Data Lavoro</label>
                    </div>

                    <!-- Cantiere -->
                    <div class="input-group">
                        <select id="cantiere" name="cantiere" class="input-field" required>
                            <option value="">Caricamento cantieri...</option>
                        </select>
                        <label for="cantiere" class="input-label">Cantiere</label>
                        <div class="error-message">Seleziona un cantiere</div>
                    </div>

                    <!-- Note -->
                    <div class="input-group">
                        <textarea id="note" name="note" class="input-field" placeholder=" " rows="3"></textarea>
                        <label for="note" class="input-label">Note (opzionale)</label>
                        <div class="input-helper">Eventuali dettagli aggiuntivi sul lavoro svolto</div>
                    </div>

                    <!-- Ore Lavorate (Special) -->
                    <div class="input-group hours-group">
                        <input type="text" id="ore" name="ore" class="input-field hours-input" placeholder=" " required autocomplete="off">
                        <label for="ore" class="input-label hours-label">Ore Lavorate</label>
                        <div class="input-helper">Usa il punto per i decimali (es: 8.5)</div>
                        <div class="error-message">Inserisci ore valide (0-24)</div>
                    </div>
                </div>
            </form>

            <div class="save-section">
                <button type="submit" class="btn btn-primary" id="saveBtn" form="workEntryForm">
                    <span class="material-icon">save</span>
                    Salva Ore
                </button>
                <div class="save-info">
                    <span class="material-icon">sync</span>
                    I totali si aggiornano automaticamente
                </div>
            </div>
        </div>
    </div>

    <!-- Notifiche -->
    <div id="notification" class="notification"></div>

    <!-- Badge versione -->
    <div class="version-badge" id="versionBadge" title="Dashboard V3.5 Material Design">
        v3.5 MD
    </div>

    <script src="config.js"></script>
    <script>
        let currentUser = null;
        let sessionToken = null;
        let cantieri = [];

        // ‚ö° INIZIALIZZAZIONE V3.5 - Material Design Mobile First
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('‚ö° Dashboard V3.5 Material Design avviata');
            
            // Verifica accesso
            if (!PageGuard.requireLogin()) {
                return;
            }
            
            // Setup auto-logout
            Utils.setupAutoLogout();
            
            // Carica dati utente dalla sessione
            const session = Utils.getSession();
            currentUser = session.user;
            sessionToken = session.token;
            
            // ‚ö° CARICAMENTO IMMEDIATO UI
            loadUserData();
            
            // Imposta data odierna
            document.getElementById('workDate').value = new Date().toISOString().split('T')[0];
            
            // Setup form subito
            setupMaterialForm();
            
            // ‚úÖ CARICAMENTO PARALLELO API
            console.log('‚ö° Avvio caricamento parallelo...');
            const startTime = performance.now();
            
            try {
                await Promise.all([
                    loadCantieri(),
                    refreshUserStats()
                ]);
                
                const endTime = performance.now();
                const loadTime = (endTime - startTime).toFixed(0);
                console.log(`‚ö° Caricamento completato in ${loadTime}ms`);
                
                Utils.showNotification(`Dashboard caricata in ${loadTime}ms`, 'success', 2500);
                
            } catch (error) {
                console.error('‚ùå Errore nel caricamento:', error);
                Utils.showNotification('Errore nel caricamento dati', 'error');
            }
        });

        function loadUserData() {
            if (!currentUser) return;
            
            console.log('üìä Caricando dati utente Material Design:', currentUser);
            
            // Solo nome utente nell'header (come richiesto)
            document.getElementById('userName').textContent = `Ciao, ${currentUser.name}`;
            
            // Ore dai calcoli Excel
            document.getElementById('monthlyHours').textContent = Utils.formatHours(currentUser.oreMese || 0);
            document.getElementById('previousMonthHours').textContent = Utils.formatHours(currentUser.oreMesePrecedente || 0);
        }

        async function loadCantieri() {
            try {
                console.log('üìã Caricando cantieri...');
                const cantiereSelect = document.getElementById('cantiere');
                
                const result = await callGoogleAppsScript({
                    action: 'getCantieri',
                    sessionToken: sessionToken
                });
                
                if (result.success && result.data) {
                    cantieri = result.data;
                    cantiereSelect.innerHTML = '<option value="">Seleziona un cantiere</option>';
                    
                    cantieri.forEach(cantiere => {
                        const option = document.createElement('option');
                        option.value = cantiere.id;
                        option.textContent = `${cantiere.nome}${cantiere.indirizzo ? ' - ' + cantiere.indirizzo : ''}`;
                        cantiereSelect.appendChild(option);
                    });
                    
                    console.log('‚úÖ Cantieri caricati:', cantieri.length);
                } else {
                    throw new Error(result.message || 'Errore caricamento cantieri');
                }
                
            } catch (error) {
                console.error('‚ùå Errore caricamento cantieri:', error);
                const cantiereSelect = document.getElementById('cantiere');
                cantiereSelect.innerHTML = '<option value="">Errore caricamento cantieri</option>';
                Utils.showNotification('Errore nel caricamento cantieri', 'error');
            }
        }

        // Setup Material Form ottimizzato per mobile
        function setupMaterialForm() {
            const form = document.getElementById('workEntryForm');
            const oreInput = document.getElementById('ore');
            
            // Material Design Input Animations
            setupMaterialInputs();
            
            // Gestione ore con decimali - Mobile friendly
            oreInput.addEventListener('input', function(e) {
                let value = e.target.value;
                
                // Sostituisci virgola con punto
                if (value.includes(',')) {
                    value = value.replace(',', '.');
                    e.target.value = value;
                }
                
                clearValidation(e.target);
                
                // Vibrazione feedback su mobile (se supportata)
                if ('vibrate' in navigator && value && !isNaN(parseFloat(value))) {
                    navigator.vibrate(10); // Feedback sottile
                }
            });
            
            // Gestione blur con debounce per performance mobile
            let blurTimeout;
            oreInput.addEventListener('blur', function(e) {
                clearTimeout(blurTimeout);
                blurTimeout = setTimeout(() => {
                    validateHoursField(e.target);
                }, 150);
            });
            
            // Submit form con prevenzione double-tap
            let submitInProgress = false;
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                if (submitInProgress) return;
                submitInProgress = true;
                
                try {
                    await saveWorkEntry();
                } finally {
                    setTimeout(() => {
                        submitInProgress = false;
                    }, 1000); // Cooldown per evitare doppi submit
                }
            });

            // Validazione campi ottimizzata
            ['workDate', 'cantiere'].forEach(fieldId => {
                const field = document.getElementById(fieldId);
                
                // Debounced validation per performance
                let validationTimeout;
                field.addEventListener('blur', () => {
                    clearTimeout(validationTimeout);
                    validationTimeout = setTimeout(() => {
                        validateField(field);
                    }, 200);
                });
                
                field.addEventListener('change', () => {
                    clearValidation(field);
                    // Feedback vibrazione per selezione (mobile)
                    if ('vibrate' in navigator && field.value) {
                        navigator.vibrate(5);
                    }
                });
            });
            
            console.log('‚úÖ Material Design form mobile-optimized setup completato');
        }

        function setupMaterialInputs() {
            const inputs = document.querySelectorAll('.input-field');
            
            inputs.forEach(input => {
                // Controlla se il campo √® gi√† compilato
                if (input.value && input.value.trim() !== '') {
                    input.classList.add('has-value');
                }
                
                // Focus events con ottimizzazioni mobile
                input.addEventListener('focus', () => {
                    input.classList.add('focused');
                    // Scroll automatico per campo ore su mobile
                    if (input.id === 'ore' && window.innerWidth < 768) {
                        setTimeout(() => {
                            input.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'center' 
                            });
                        }, 300);
                    }
                });
                
                input.addEventListener('blur', () => {
                    input.classList.remove('focused');
                    updateInputState(input);
                });
                
                input.addEventListener('input', () => {
                    updateInputState(input);
                });
                
                // Touch events per miglior UX mobile
                input.addEventListener('touchstart', () => {
                    input.classList.add('touched');
                }, { passive: true });
            });
        }
        
        function updateInputState(input) {
            const hasValue = input.value && input.value.trim() !== '';
            input.classList.toggle('has-value', hasValue);
            
            // Gestione speciale per select
            if (input.tagName === 'SELECT' && input.value !== '') {
                input.classList.add('has-value');
            }
        }

        function validateHoursField(field) {
            let value = field.value.trim();
            
            if (value.includes(',')) {
                value = value.replace(',', '.');
                field.value = value;
            }
            
            const hours = parseFloat(value);
            const isValid = !isNaN(hours) && hours >= 0 && hours <= 24 && value !== '';
            
            if (!isValid) {
                field.classList.add('input-error');
                const errorMsg = field.parentElement.querySelector('.error-message');
                if (errorMsg) errorMsg.style.display = 'block';
                return false;
            } else {
                clearValidation(field);
                return true;
            }
        }

        function validateField(field) {
            const value = field.value.trim();
            const isValid = field.hasAttribute('required') ? value !== '' : true;
            
            if (!isValid) {
                field.classList.add('input-error');
                const errorMsg = field.parentElement.querySelector('.error-message');
                if (errorMsg) errorMsg.style.display = 'block';
                return false;
            } else {
                clearValidation(field);
                return true;
            }
        }

        function clearValidation(field) {
            field.classList.remove('input-error');
            const errorMsg = field.parentElement.querySelector('.error-message');
            if (errorMsg) errorMsg.style.display = 'none';
        }

        async function saveWorkEntry() {
            const saveBtn = document.getElementById('saveBtn');
            const form = document.getElementById('workEntryForm');
            
            // Validazione form
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            // Gestione ore con decimali
            let oreValue = data.ore.trim();
            if (oreValue.includes(',')) {
                oreValue = oreValue.replace(',', '.');
            }
            
            const oreParsed = parseFloat(oreValue);
            
            console.log('üî¢ Debug ore Material Design:', {
                original: data.ore,
                cleaned: oreValue,
                parsed: oreParsed,
                isValid: !isNaN(oreParsed) && oreParsed >= 0 && oreParsed <= 24
            });
            
            // Validazione tutti i campi
            let isValid = true;
            ['workDate', 'cantiere'].forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!validateField(field)) {
                    isValid = false;
                }
            });
            
            const oreField = document.getElementById('ore');
            if (!validateHoursField(oreField)) {
                isValid = false;
            }
            
            if (!isValid) {
                Utils.showNotification('Completa tutti i campi obbligatori', 'error');
                return;
            }
            
            // Material Design Loading State
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="loading"></span>Salvando...';
            
            try {
                console.log('üíæ Salvando ore con Material Design...');
                
                const result = await callGoogleAppsScript({
                    action: 'saveWorkEntry',
                    sessionToken: sessionToken,
                    workData: {
                        data: data.workDate,
                        cantiereId: data.cantiere,
                        lavori: 'Lavoro registrato via dashboard Material Design',
                        ore: oreParsed,
                        note: data.note || ''
                    }
                });
                
                if (result.success) {
                    Utils.showNotification(`${oreParsed} ore salvate con successo!`, 'success');
                    
                    // Reset form mantenendo data
                    const currentDate = data.workDate;
                    form.reset();
                    document.getElementById('workDate').value = currentDate;
                    
                    // Re-setup Material inputs dopo reset
                    setupMaterialInputs();
                    
                    // Aggiorna stats dopo salvataggio
                    setTimeout(() => {
                        refreshUserStats();
                    }, 1500);
                    
                } else {
                    throw new Error(result.message || 'Errore nel salvataggio');
                }
                
                            } catch (error) {
                console.error('‚ùå Errore salvataggio:', error);
                Utils.showNotification('Errore nel salvataggio: ' + error.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<span class="material-icon">save</span>Salva Ore';
            }
        }

        async function refreshUserStats() {
            try {
                console.log('üîÑ Aggiornando statistiche Material Design...');
                
                const result = await callGoogleAppsScript({
                    action: 'getUserInfo',
                    sessionToken: sessionToken
                });
                
                if (result.success && result.data) {
                    // Aggiorna currentUser
                    currentUser = { ...currentUser, ...result.data };
                    
                    // Aggiorna UI con animazioni Material
                    updateStatsWithAnimation(result.data);
                    
                    console.log('‚úÖ Statistiche Material Design aggiornate:', result.data);
                } else {
                    console.log('‚ö†Ô∏è Impossibile aggiornare statistiche:', result.message);
                }
            } catch (error) {
                console.error('‚ùå Errore aggiornamento stats:', error);
            }
        }

        function updateStatsWithAnimation(data) {
            const monthlyEl = document.getElementById('monthlyHours');
            const previousEl = document.getElementById('previousMonthHours');
            
            // Animate counter
            animateCounter(monthlyEl, parseFloat(data.oreMese || 0));
            animateCounter(previousEl, parseFloat(data.oreMesePrecedente || 0));
        }

        function animateCounter(element, targetValue) {
            const startValue = parseFloat(element.textContent) || 0;
            const increment = (targetValue - startValue) / 30;
            let currentValue = startValue;
            
            const timer = setInterval(() => {
                currentValue += increment;
                if ((increment > 0 && currentValue >= targetValue) || 
                    (increment < 0 && currentValue <= targetValue)) {
                    currentValue = targetValue;
                    clearInterval(timer);
                }
                element.textContent = Utils.formatHours(currentValue);
            }, 20);
        }

        async function callGoogleAppsScript(params) {
            if (typeof Utils !== 'undefined' && Utils.callAPI) {
                return await Utils.callAPI(params);
            } else {
                throw new Error('Utils.callAPI non disponibile - verifica config.js');
            }
        }

        function logout() {
            if (confirm('Sei sicuro di voler uscire?')) {
                if (typeof Utils !== 'undefined') {
                    Utils.clearSession();
                    Utils.showNotification('Logout effettuato con successo', 'success');
                    setTimeout(() => {
                        Utils.redirectToLogin();
                    }, 1500);
                } else {
                    // Fallback senza Utils
                    sessionStorage.clear();
                    window.location.href = 'index.html';
                }
            }
        }

        // Material Design Notification Override
        Utils.showNotification = function(message, type = 'success', duration = null) {
            let notification = document.getElementById('notification');
            
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'notification';
                notification.className = 'notification';
                document.body.appendChild(notification);
            }
            
            // Material Icons per notifiche
            const icons = {
                success: 'check_circle',
                error: 'error',
                warning: 'warning',
                info: 'info',
                security: 'security'
            };
            
            const icon = icons[type] || icons.info;
            notification.innerHTML = `<span class="material-icon">${icon}</span>${message}`;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            const notificationDuration = duration || CONFIG.UI.NOTIFICATION_DURATION;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, notificationDuration);
        };

        // Debug info per version badge
        document.getElementById('versionBadge').addEventListener('click', function() {
            const session = Utils.getSession();
            let debugInfo = `Dashboard V3.5 Material Design Debug:\n\n`;
            debugInfo += `Frontend: 3.5.0 Material Design\n`;
            debugInfo += `Build: 2025.07.04\n`;
            debugInfo += `Design: Mobile First + Material Design\n`;
            debugInfo += `User: ${session.user ? session.user.name : 'Non loggato'}\n`;
            debugInfo += `Session Token: ${session.token ? 'Presente' : 'Assente'}\n`;
            debugInfo += `Cantieri: ${cantieri.length}\n`;
            debugInfo += `Responsive: Mobile First ‚úÖ`;
            
            alert(debugInfo);
        });

        // Auto-refresh stats ogni 5 minuti
        setInterval(() => {
            if (Utils.isLoggedIn()) {
                refreshUserStats();
            }
        }, 5 * 60 * 1000);

        // Material Design Ripple Effect (bonus)
        document.querySelectorAll('.btn').forEach(button => {
            button.addEventListener('click', function(e) {
                const ripple = document.createElement('span');
                const rect = this.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;
                
                ripple.style.cssText = `
                    position: absolute;
                    width: ${size}px;
                    height: ${size}px;
                    left: ${x}px;
                    top: ${y}px;
                    background: rgba(255, 255, 255, 0.3);
                    border-radius: 50%;
                    transform: scale(0);
                    animation: ripple 0.6s ease-out;
                    pointer-events: none;
                `;
                
                this.appendChild(ripple);
                
                setTimeout(() => {
                    ripple.remove();
                }, 600);
            });
        });

        // CSS per l'animazione ripple
        const style = document.createElement('style');
        style.textContent = `
            @keyframes ripple {
                to {
                    transform: scale(2);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
